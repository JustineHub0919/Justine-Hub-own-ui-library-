-- Kaze UI Base (Improved)
-- Window System (PC + Mobile)
-- Added: Responsive sizing for PC/Mobile, Multi-Tab support (CreateTab), bug fixes and safety improvements.
-- Usage:
-- local UI = KazeUI:CreateWindow{ Title = "My UI", Icon = "6031763447" }
-- local MainTab = UI:CreateTab("Main", "rbxassetid://6031763447")
-- local OtherTab = UI:CreateTab("Other", "123456")
-- Each tab returns { Button = buttonInstance, Content = contentFrame } for adding controls.

local KazeUI = {}
KazeUI.__index = KazeUI

--// Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local LP = Players.LocalPlayer

--// Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KazeUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = LP:WaitForChild("PlayerGui")

--// UIScale for consistent scaling across devices
local UIScale = Instance.new("UIScale")
UIScale.Parent = ScreenGui

local function UpdateScale()
	local size = workspace.CurrentCamera.ViewportSize
	if size.X < 600 then
		UIScale.Scale = math.clamp(size.X / 800, 0.48, 0.9)
	else
		UIScale.Scale = math.clamp(size.X / 1920, 0.6, 1)
	end
end
UpdateScale()
workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(UpdateScale)

--// Texture ID Sanitizer (robust)
local function FormatImage(id)
	if not id then return "" end
	id = tostring(id)
	-- If the string already looks like rbxassetid:// or rbxthumb, try to extract digits
	local digits = string.gsub(id, "%D", "")
	if digits == "" then return "" end
	return "rbxassetid://" .. digits
end

--// Drag Function (works with Mouse and Touch)
local function MakeDraggable(dragPart, targetPart)
	local dragging = false
	local dragInput, dragStart, startPos

	local function update(input)
		if not dragStart or not startPos then return end
		local delta = input.Position - dragStart
		targetPart.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end

	-- InputBegan on dragPart
	dragPart.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = targetPart.Position
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
					dragInput = nil
				end
			end)
		end
	end)

	dragPart.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)

	UIS.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			update(input)
		end
	end)
end

--// CREATE WINDOW
function KazeUI:CreateWindow(config)
	config = config or {}

	-- Main Config
	local Title = config.Title or "Kaze UI"
	local Author = config.Author or "Unknown"
	local Version = config.Version or "1.0"
	local MainIcon = FormatImage(config.Icon or "6031763447")

	-- Open Button Config (ENFORCED to 60x60 for mobile playability)
	local OpenIcon = FormatImage((config.OpenButton and config.OpenButton.Icon) or config.Icon or "6031763447")
	local MiniButtonSize = UDim2.fromOffset(60, 60)

	local Callback = config.Callback

	--// Main Window (Frame)
	local WindowFrame = Instance.new("Frame")
	WindowFrame.Name = "MainWindow"
	WindowFrame.Size = UDim2.fromOffset(700, 500) -- increased base size
	WindowFrame.Position = UDim2.fromScale(0.5, 0.5)
	WindowFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	WindowFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
	WindowFrame.BorderSizePixel = 0
	WindowFrame.Parent = ScreenGui
	WindowFrame.ClipsDescendants = true
	Instance.new("UICorner", WindowFrame).CornerRadius = UDim.new(0, 14)

	local WindowStroke = Instance.new("UIStroke")
	WindowStroke.Color = Color3.fromRGB(0, 160, 255)
	WindowStroke.Thickness = 2.5 -- neon thickness
	WindowStroke.Parent = WindowFrame

	spawn(function()
		-- single tween loop for neon effect
		local t = TweenService:Create(WindowStroke, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {Color = Color3.fromRGB(0, 255, 255)})
		t:Play()
	end)

	-- Responsive window size: changes with viewport size (PC vs Mobile)
	local function AdjustWindowSize()
		local size = workspace.CurrentCamera.ViewportSize
		if size.X <= 600 then
			-- Mobile: almost full width, moderate height
			WindowFrame.Size = UDim2.new(0.94, 0, 0.86, 0)
		elseif size.X <= 1280 then
			-- Small laptops/tablets
			WindowFrame.Size = UDim2.new(0.78, 0, 0.75, 0)
		else
			-- Desktop
			WindowFrame.Size = UDim2.new(0.60, 0, 0.68, 0)
		end
		WindowFrame.Position = UDim2.fromScale(0.5, 0.5)
		WindowFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	end
	AdjustWindowSize()
	workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(AdjustWindowSize)

	--// Top Bar
	local TopBar = Instance.new("Frame")
	TopBar.Name = "TopBar"
	TopBar.Size = UDim2.new(1, 0, 0, 56)
	TopBar.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
	TopBar.BorderSizePixel = 0
	TopBar.Parent = WindowFrame
	Instance.new("UICorner", TopBar).CornerRadius = UDim.new(0, 14)
	MakeDraggable(TopBar, WindowFrame)

	local Icon = Instance.new("ImageLabel")
	Icon.Size = UDim2.fromOffset(32, 32)
	Icon.Position = UDim2.fromOffset(14, 12)
	Icon.BackgroundTransparency = 1
	Icon.Image = MainIcon
	Icon.Parent = TopBar
	Instance.new("UICorner", Icon).CornerRadius = UDim.new(1, 0)

	local TitleLabel = Instance.new("TextLabel")
	TitleLabel.Size = UDim2.new(1, -200, 0, 22)
	TitleLabel.Position = UDim2.fromOffset(56, 8)
	TitleLabel.BackgroundTransparency = 1
	TitleLabel.Text = Title
	TitleLabel.TextColor3 = Color3.fromRGB(235, 235, 235)
	TitleLabel.Font = Enum.Font.GothamBold
	TitleLabel.TextSize = 16
	TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
	TitleLabel.Parent = TopBar

	local SubLabel = Instance.new("TextLabel")
	SubLabel.Size = UDim2.new(1, -200, 0, 18)
	SubLabel.Position = UDim2.fromOffset(56, 30)
	SubLabel.BackgroundTransparency = 1
	SubLabel.Text = Author .. " | v" .. Version
	SubLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
	SubLabel.Font = Enum.Font.Gotham
	SubLabel.TextSize = 13
	SubLabel.TextXAlignment = Enum.TextXAlignment.Left
	SubLabel.Parent = TopBar

	local Minimize = Instance.new("TextButton")
	Minimize.Size = UDim2.fromOffset(36, 36)
	Minimize.Position = UDim2.new(1, -88, 0.5, -18)
	Minimize.Text = "—"
	Minimize.Font = Enum.Font.GothamBold
	Minimize.TextSize = 20
	Minimize.TextColor3 = Color3.fromRGB(220, 220, 220)
	Minimize.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
	Minimize.Parent = TopBar
	Instance.new("UICorner", Minimize).CornerRadius = UDim.new(1, 0)

	local Close = Instance.new("TextButton")
	Close.Size = UDim2.fromOffset(36, 36)
	Close.Position = UDim2.new(1, -44, 0.5, -18)
	Close.Text = "✕"
	Close.Font = Enum.Font.GothamBold
	Close.TextSize = 18
	Close.TextColor3 = Color3.fromRGB(255, 90, 90)
	Close.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
	Close.Parent = TopBar
	Instance.new("UICorner", Close).CornerRadius = UDim.new(1, 0)

	--// Main area: left tabs column + right content
	local MainArea = Instance.new("Frame")
	MainArea.Name = "MainArea"
	MainArea.Position = UDim2.fromOffset(0, 56)
	MainArea.Size = UDim2.new(1, 0, 1, -56)
	MainArea.BackgroundTransparency = 1
	MainArea.Parent = WindowFrame

	-- Left Tabs (sidebar)
	local TabsHolder = Instance.new("Frame")
	TabsHolder.Name = "TabsHolder"
	TabsHolder.Position = UDim2.new(0, 12, 0, 12)
	TabsHolder.Size = UDim2.new(0, 200, 1, -24) -- fixed pixel width suits both mobile & PC with scale higher up top
	TabsHolder.BackgroundTransparency = 1
	TabsHolder.Parent = MainArea

	local TabsBackground = Instance.new("Frame")
	TabsBackground.Size = UDim2.new(1, 0, 1, 0)
	TabsBackground.BorderSizePixel = 0
	TabsBackground.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
	TabsBackground.Parent = TabsHolder
	Instance.new("UICorner", TabsBackground).CornerRadius = UDim.new(0, 12)

	local TabsScroll = Instance.new("ScrollingFrame")
	TabsScroll.Name = "TabsScroll"
	TabsScroll.Size = UDim2.new(1, 0, 1, 0)
	TabsScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	TabsScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
	TabsScroll.ScrollBarThickness = 6
	TabsScroll.BackgroundTransparency = 1
	TabsScroll.Parent = TabsBackground

	local TabsLayout = Instance.new("UIListLayout")
	TabsLayout.Parent = TabsScroll
	TabsLayout.SortOrder = Enum.SortOrder.LayoutOrder
	TabsLayout.Padding = UDim.new(0, 8)

	-- Right Content Area
	local PagesHolder = Instance.new("Frame")
	PagesHolder.Name = "PagesHolder"
	PagesHolder.Position = UDim2.new(0, 224, 0, 12)
	PagesHolder.Size = UDim2.new(1, -236, 1, -24)
	PagesHolder.BackgroundTransparency = 1
	PagesHolder.Parent = MainArea

	-- Container for pages (stacked; only active visible)
	local PagesContainer = Instance.new("Frame")
	PagesContainer.Size = UDim2.new(1, 0, 1, 0)
	PagesContainer.BackgroundTransparency = 1
	PagesContainer.Parent = PagesHolder

	--// MINI BUTTON (60x60 Square ImageButton)
	local MiniButton = Instance.new("ImageButton")
	MiniButton.Name = "MiniButton"
	MiniButton.Size = MiniButtonSize -- enforced exact 60x60
	MiniButton.Position = UDim2.fromScale(0.1, 0.1)
	MiniButton.BackgroundColor3 = Color3.fromRGB(20, 20, 25) -- solid background
	MiniButton.BorderSizePixel = 0
	MiniButton.Visible = false
	MiniButton.Parent = ScreenGui -- parent directly to ScreenGui to remain visible when Window hidden
	MiniButton.ZIndex = 999 -- ensure never hidden behind other UI
	MiniButton.ScaleType = Enum.ScaleType.Slice
	MiniButton.SliceCenter = Rect.new(4,4,56,56)

	local miniUICorner = Instance.new("UICorner")
	miniUICorner.CornerRadius = UDim.new(0, 12)
	miniUICorner.Parent = MiniButton

	local miniPadding = Instance.new("UIPadding")
	miniPadding.PaddingTop = UDim.new(0, 6)
	miniPadding.PaddingBottom = UDim.new(0, 6)
	miniPadding.PaddingLeft = UDim.new(0, 6)
	miniPadding.PaddingRight = UDim.new(0, 6)
	miniPadding.Parent = MiniButton

	local MiniIcon = Instance.new("ImageLabel")
	MiniIcon.Size = UDim2.fromScale(1, 1)
	MiniIcon.Position = UDim2.fromScale(0.5, 0.5)
	MiniIcon.AnchorPoint = Vector2.new(0.5, 0.5)
	MiniIcon.BackgroundTransparency = 1
	MiniIcon.Image = OpenIcon
	MiniIcon.Parent = MiniButton
	MiniIcon.ZIndex = 1000

	local MiniStroke = Instance.new("UIStroke")
	MiniStroke.Color = Color3.fromRGB(0, 160, 255)
	MiniStroke.Thickness = 2.5 -- neon thickness
	MiniStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	MiniStroke.Parent = MiniButton
	MiniStroke.LineJoinMode = Enum.LineJoinMode.Bevel

	spawn(function()
		local t = TweenService:Create(MiniStroke, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {Color = Color3.fromRGB(0, 255, 255)})
		t:Play()
	end)

	-- Make both TopBar and MiniButton draggable
	MakeDraggable(TopBar, WindowFrame)
	MakeDraggable(MiniButton, MiniButton)

	-- Minimize behavior
	Minimize.MouseButton1Click:Connect(function()
		WindowFrame.Visible = false
		MiniButton.Visible = true
		MiniButton.Size = UDim2.fromOffset(0, 0)
		TweenService:Create(MiniButton, TweenInfo.new(0.28, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = MiniButtonSize}):Play()
	end)

	-- Restore behavior
	MiniButton.MouseButton1Click:Connect(function()
		MiniButton.Visible = false
		WindowFrame.Visible = true
		-- animate window resize back (tweening size)
		-- We'll call AdjustWindowSize to compute desired size then tween to that size.
		local sizeFinal = WindowFrame.Size
		WindowFrame.Size = UDim2.fromOffset(0, 0)
		TweenService:Create(WindowFrame, TweenInfo.new(0.28, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = sizeFinal}):Play()
	end)

	-- Close Logic with confirmation overlay
	local function ShowCloseConfirm()
		Minimize.Active = false
		Close.Active = false
		local Overlay = Instance.new("Frame")
		Overlay.Size = UDim2.new(1, 0, 1, 0)
		Overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
		Overlay.BackgroundTransparency = 0.6
		Overlay.ZIndex = 20
		Overlay.Parent = WindowFrame

		local ConfirmWindow = Instance.new("Frame")
		ConfirmWindow.Size = UDim2.fromOffset(350, 150)
		ConfirmWindow.AnchorPoint = Vector2.new(0.5, 0.5)
		ConfirmWindow.Position = UDim2.fromScale(0.5, 0.5)
		ConfirmWindow.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
		ConfirmWindow.ZIndex = 21
		ConfirmWindow.Parent = Overlay
		Instance.new("UICorner", ConfirmWindow).CornerRadius = UDim.new(0, 12)

		local ConfirmText = Instance.new("TextLabel")
		ConfirmText.Size = UDim2.new(1, -32, 0, 48)
		ConfirmText.Position = UDim2.fromOffset(16, 20)
		ConfirmText.BackgroundTransparency = 1
		ConfirmText.Text = "Are you sure you want to close the UI?"
		ConfirmText.TextColor3 = Color3.fromRGB(230, 230, 230)
		ConfirmText.Font = Enum.Font.GothamBold
		ConfirmText.TextSize = 18
		ConfirmText.TextWrapped = true
		ConfirmText.ZIndex = 22
		ConfirmText.Parent = ConfirmWindow

		local ButtonsFrame = Instance.new("Frame")
		ButtonsFrame.Size = UDim2.new(1, 0, 0, 40)
		ButtonsFrame.Position = UDim2.new(0, 0, 1, -20)
		ButtonsFrame.AnchorPoint = Vector2.new(0, 1)
		ButtonsFrame.BackgroundTransparency = 1
		ButtonsFrame.ZIndex = 22
		ButtonsFrame.Parent = ConfirmWindow

		local layout = Instance.new("UIListLayout")
		layout.Parent = ButtonsFrame
		layout.FillDirection = Enum.FillDirection.Horizontal
		layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
		layout.Padding = UDim.new(0, 16)

		local ConfirmBtn = Instance.new("TextButton")
		ConfirmBtn.Size = UDim2.new(0, 120, 0, 36)
		ConfirmBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
		ConfirmBtn.Text = "Confirm"
		ConfirmBtn.TextColor3 = Color3.fromRGB(230, 230, 230)
		ConfirmBtn.Font = Enum.Font.GothamBold
		ConfirmBtn.TextSize = 16
		ConfirmBtn.ZIndex = 23
		ConfirmBtn.Parent = ButtonsFrame
		Instance.new("UICorner", ConfirmBtn).CornerRadius = UDim.new(0, 8)

		local CancelBtn = Instance.new("TextButton")
		CancelBtn.Size = UDim2.new(0, 120, 0, 36)
		CancelBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
		CancelBtn.Text = "Cancel"
		CancelBtn.TextColor3 = Color3.fromRGB(220, 220, 220)
		CancelBtn.Font = Enum.Font.GothamBold
		CancelBtn.TextSize = 16
		CancelBtn.ZIndex = 23
		CancelBtn.Parent = ButtonsFrame
		Instance.new("UICorner", CancelBtn).CornerRadius = UDim.new(0, 8)

		ConfirmBtn.MouseButton1Click:Connect(function()
			ScreenGui:Destroy()
		end)
		CancelBtn.MouseButton1Click:Connect(function()
			Overlay:Destroy()
			Minimize.Active = true
			Close.Active = true
		end)
	end
	Close.MouseButton1Click:Connect(ShowCloseConfirm)

	-- Tab management state
	local tabs = {}
	local activeTabButton = nil

	-- Helper to set active tab
	local function SetActiveTab(tabObject)
		-- hide all pages, de-highlight buttons
		for _, t in ipairs(tabs) do
			t.Content.Visible = false
			t.Button.BackgroundColor3 = Color3.fromRGB(30, 30, 36)
			t.Button.TextColor3 = Color3.fromRGB(220, 220, 220)
		end
		-- show the requested
		if tabObject then
			tabObject.Content.Visible = true
			tabObject.Button.BackgroundColor3 = Color3.fromRGB(0, 160, 255)
			tabObject.Button.TextColor3 = Color3.fromRGB(10, 10, 10)
			activeTabButton = tabObject.Button
		end
	end

	-- CreateTab function exposed on returned object
	local function CreateTab(title, icon)
		local iconImage = FormatImage(icon or "")
		local tabIndex = #tabs + 1

		-- Create the button
		local Btn = Instance.new("TextButton")
		Btn.Name = "TabButton_" .. tostring(tabIndex)
		Btn.Size = UDim2.new(1, -20, 0, 56)
		Btn.BackgroundColor3 = Color3.fromRGB(30, 30, 36)
		Btn.BorderSizePixel = 0
		Btn.Text = title or ("Tab " .. tostring(tabIndex))
		Btn.TextColor3 = Color3.fromRGB(220, 220, 220)
		Btn.Font = Enum.Font.GothamBold
		Btn.TextSize = 16
		Btn.TextXAlignment = Enum.TextXAlignment.Left
		Btn.Parent = TabsScroll
		Btn.LayoutOrder = tabIndex
		Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 10)

		-- Icon on the left
		local BtnIcon = Instance.new("ImageLabel")
		BtnIcon.Size = UDim2.fromOffset(36, 36)
		BtnIcon.Position = UDim2.fromOffset(8, 10)
		BtnIcon.BackgroundTransparency = 1
		BtnIcon.Image = iconImage
		BtnIcon.Parent = Btn
		Instance.new("UICorner", BtnIcon).CornerRadius = UDim.new(1, 0)

		-- Adjust text padding so it doesn't overlap icon
		local txtPadding = Instance.new("UIPadding")
		txtPadding.PaddingLeft = UDim.new(0, 56)
		txtPadding.Parent = Btn

		-- Create the content page
		local Page = Instance.new("Frame")
		Page.Name = "Page_" .. tostring(tabIndex)
		Page.Size = UDim2.new(1, 0, 1, 0)
		Page.BackgroundTransparency = 1
		Page.Parent = PagesContainer
		Page.Visible = false

		-- Provide a layout for the content (useful for adding sections)
		local ContentLayout = Instance.new("UIListLayout")
		ContentLayout.Parent = Page
		ContentLayout.Padding = UDim.new(0, 12)
		ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
		ContentLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

		-- Add to tabs list
		local tabObj = {Button = Btn, Content = Page}
		table.insert(tabs, tabObj)

		-- Update the scrollbar canvas size after a short delay
		task.defer(function()
			TabsScroll.CanvasSize = UDim2.new(0, 0, 0, TabsLayout.AbsoluteContentSize.Y + 12)
		end)

		-- When button clicked, set active
		Btn.MouseButton1Click:Connect(function()
			SetActiveTab(tabObj)
		end)

		-- Auto-select the first tab if this is the only one
		if #tabs == 1 then
			SetActiveTab(tabObj)
		end

		-- Return the tab object for the caller to populate
		return tabObj
	end

	-- Expose a method to programmatically switch tabs by index or title
	local function GetTabIndexByTitle(t)
		for i, tab in ipairs(tabs) do
			if tab.Button and tab.Button.Text == t then
				return i
			end
		end
		return nil
	end

	local function SetActiveTabByIndex(index)
		local tab = tabs[index]
		if tab then SetActiveTab(tab) end
	end

	-- Build the returned API object (a table that acts as the Window controller)
	local WindowAPI = {}
	WindowAPI.Frame = WindowFrame
	WindowAPI.TopBar = TopBar
	WindowAPI.Icon = Icon
	WindowAPI.MiniButton = MiniButton
	WindowAPI.TabsHolder = TabsHolder
	WindowAPI.PagesHolder = PagesHolder
	WindowAPI.CreateTab = CreateTab
	WindowAPI.SetActiveTabByIndex = SetActiveTabByIndex
	WindowAPI.GetTabIndexByTitle = GetTabIndexByTitle
	WindowAPI.Destroy = function()
		if ScreenGui and ScreenGui.Parent then
			ScreenGui:Destroy()
		end
	end

	-- Run callback if provided
	if typeof(Callback) == "function" then
		pcall(Callback)
	end

	return WindowAPI
end

return KazeUI
