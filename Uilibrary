-- Minimal KazeUI
-- Provides Window / Tabs / Sections
-- Sections support only :AddLabel (no other builtin elements)

local KazeUI = {}
KazeUI.__index = KazeUI

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local LP = Players.LocalPlayer

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KazeUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = LP:WaitForChild("PlayerGui")

-- UIScale
local UIScale = Instance.new("UIScale")
UIScale.Parent = ScreenGui
local function UpdateScale()
	local size = workspace.CurrentCamera.ViewportSize
	if size.X < 600 then
		UIScale.Scale = math.clamp(size.X / 800, 0.5, 1)
	else
		UIScale.Scale = math.clamp(size.X / 1920, 0.6, 1)
	end
end
UpdateScale()
workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(UpdateScale)

-- safe image formatting
local function FormatImage(id)
	if not id then return "" end
	local s = tostring(id)
	local clean = string.gsub(s, "%D", "")
	if clean == "" then return "" end
	return "rbxassetid://" .. clean
end

-- draggable helper
local function MakeDraggable(dragPart, targetPart)
	local dragging, dragInput, dragStart, startPos = false, nil, nil, nil
	local function update(input)
		if not dragStart or not startPos then return end
		local delta = input.Position - dragStart
		targetPart.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
	dragPart.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = targetPart.Position
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
					dragInput = nil
				end
			end)
		end
	end)
	dragPart.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)
	UIS.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			update(input)
		end
	end)
end

-- small neon pulse helper for UIStroke
local function PlayNeonPulse(instance, property, duration)
	if not instance then return end
	local ti = TweenInfo.new(duration or 1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	local altColor = Color3.fromRGB(0, 255, 255)
	local goal = {}
	goal[property] = altColor
	local tw = TweenService:Create(instance, ti, goal)
	tw:Play()
	return tw
end

function KazeUI:CreateWindow(config)
	config = config or {}
	local Title = config.Title or "Kaze UI"
	local Author = config.Author or "Unknown"
	local Version = config.Version or "1.0"
	local MainIcon = FormatImage(config.Icon or "")

	local Window = Instance.new("Frame")
	Window.Name = "MainWindow"
	Window.Size = UDim2.fromOffset(650, 420)
	Window.Position = UDim2.fromScale(0.5, 0.5)
	Window.AnchorPoint = Vector2.new(0.5, 0.5)
	Window.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
	Window.BorderSizePixel = 0
	Window.Parent = ScreenGui
	Window.ClipsDescendants = true
	Instance.new("UICorner", Window).CornerRadius = UDim.new(0, 14)

	local WindowStroke = Instance.new("UIStroke")
	WindowStroke.Color = Color3.fromRGB(0, 160, 255)
	WindowStroke.Thickness = 2.5
	WindowStroke.Parent = Window
	PlayNeonPulse(WindowStroke, "Color", 1.6)

	-- Top bar (title only)
	local TopBar = Instance.new("Frame")
	TopBar.Name = "TopBar"
	TopBar.Size = UDim2.new(1, 0, 0, 56)
	TopBar.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
	TopBar.BorderSizePixel = 0
	TopBar.Parent = Window
	Instance.new("UICorner", TopBar).CornerRadius = UDim.new(0, 14)
	MakeDraggable(TopBar, Window)

	local Icon = Instance.new("ImageLabel")
	Icon.Size = UDim2.fromOffset(32, 32)
	Icon.Position = UDim2.fromOffset(14, 12)
	Icon.BackgroundTransparency = 1
	Icon.Image = MainIcon
	Icon.Parent = TopBar
	Instance.new("UICorner", Icon).CornerRadius = UDim.new(1, 0)

	local TitleLabel = Instance.new("TextLabel")
	TitleLabel.Size = UDim2.new(1, -160, 0, 22)
	TitleLabel.Position = UDim2.fromOffset(56, 8)
	TitleLabel.BackgroundTransparency = 1
	TitleLabel.Text = Title
	TitleLabel.TextColor3 = Color3.fromRGB(235, 235, 235)
	TitleLabel.Font = Enum.Font.GothamBold
	TitleLabel.TextSize = 16
	TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
	TitleLabel.Parent = TopBar

	local Content = Instance.new("Frame")
	Content.Position = UDim2.fromOffset(0, 56)
	Content.Size = UDim2.new(1, 0, 1, -56)
	Content.BackgroundTransparency = 1
	Content.Parent = Window

	-- Left tabs + divider
	local TAB_WIDTH = 140
	local LeftPanel = Instance.new("Frame")
	LeftPanel.Size = UDim2.new(0, TAB_WIDTH, 1, 0)
	LeftPanel.Position = UDim2.new(0, 0, 0, 0)
	LeftPanel.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
	LeftPanel.BorderSizePixel = 0
	LeftPanel.Parent = Content
	Instance.new("UICorner", LeftPanel).CornerRadius = UDim.new(0, 12)

	local TabsScroll = Instance.new("ScrollingFrame")
	TabsScroll.Size = UDim2.new(1, 0, 1, 0)
	TabsScroll.BackgroundTransparency = 1
	TabsScroll.ScrollBarThickness = 6
	TabsScroll.VerticalScrollBarInset = Enum.ScrollBarInset.ScrollBar
	TabsScroll.Parent = LeftPanel
	TabsScroll.BorderSizePixel = 0
	TabsScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	TabsScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y

	local tabsLayout = Instance.new("UIListLayout")
	tabsLayout.Parent = TabsScroll
	tabsLayout.SortOrder = Enum.SortOrder.LayoutOrder
	tabsLayout.Padding = UDim.new(0, 10)
	local function updateTabsCanvas()
		local totalY = tabsLayout.AbsoluteContentSize.Y
		TabsScroll.CanvasSize = UDim2.new(0, 0, 0, totalY + 12)
	end
	tabsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateTabsCanvas)

	local Divider = Instance.new("Frame")
	Divider.Size = UDim2.new(0, 2, 1, -12)
	Divider.Position = UDim2.new(0, TAB_WIDTH, 0, 6)
	Divider.BackgroundColor3 = Color3.fromRGB(0, 160, 255)
	Divider.BorderSizePixel = 0
	Divider.ZIndex = 6
	Divider.Parent = Content
	local DividerStroke = Instance.new("UIStroke")
	DividerStroke.Thickness = 2.5
	DividerStroke.Color = Color3.fromRGB(0, 160, 255)
	DividerStroke.Parent = Divider
	PlayNeonPulse(DividerStroke, "Color", 1.6)

	local Pages = Instance.new("Frame")
	Pages.Size = UDim2.new(1, -TAB_WIDTH, 1, 0)
	Pages.Position = UDim2.new(0, TAB_WIDTH, 0, 0)
	Pages.BackgroundTransparency = 1
	Pages.Parent = Content

	-- track tabs/pages/sections
	local tabs = {}
	local pages = {}
	local pagesSections = {} -- pagesSections[pageIndex] = {section1, section2, ...}
	local activeIndex = nil

	-- make tab button with minimal label (we keep tab labels for navigation)
	local function makeTabButton(name, order)
		local holder = Instance.new("Frame")
		holder.Size = UDim2.new(1, -16, 0, 48)
		holder.LayoutOrder = order
		holder.BackgroundTransparency = 1
		holder.Parent = TabsScroll

		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 1, -8)
		btn.Position = UDim2.new(0, 4, 0, 4)
		btn.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
		btn.BorderSizePixel = 0
		btn.AutoButtonColor = false
		btn.Text = name or "Tab"
		btn.Font = Enum.Font.Gotham
		btn.TextSize = 14
		btn.TextColor3 = Color3.fromRGB(220, 220, 220)
		btn.Parent = holder

		return holder, btn
	end

	local function activateTab(idx)
		if not idx then return end
		for i = 1, #tabs do
			local t = tabs[i]
			if pages[i] then
				pages[i].Visible = (i == idx)
			end
		end
		activeIndex = idx
	end

	-- public api
	local api = {}
	api.Window = Window
	api.ScreenGui = ScreenGui

	function api:AddTab(titleOrConfig)
		local title = (type(titleOrConfig) == "table") and (titleOrConfig.Title or "Tab") or tostring(titleOrConfig or "Tab")
		local order = #tabs + 1
		local holder, btn = makeTabButton(title, order)

		local page = Instance.new("Frame")
		page.Name = ("Page_%d"):format(order)
		page.Size = UDim2.new(1, 0, 1, 0)
		page.Position = UDim2.new(0, 0, 0, 0)
		page.BackgroundTransparency = 1
		page.Parent = Pages
		page.Visible = false

		local pageContent = Instance.new("Frame")
		pageContent.Name = "Content"
		pageContent.Size = UDim2.new(1, -24, 1, -24)
		pageContent.Position = UDim2.new(0, 12, 0, 12)
		pageContent.BackgroundTransparency = 1
		pageContent.Parent = page

		local pageLayout = Instance.new("UIListLayout")
		pageLayout.Parent = pageContent
		pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
		pageLayout.Padding = UDim.new(0, 16)

		tabs[order] = { Holder = holder, Button = btn, Title = title }
		pages[order] = page
		pagesSections[order] = {}

		btn.MouseButton1Click:Connect(function()
			activateTab(order)
		end)

		if order == 1 then
			activateTab(1)
		end

		local tabObj = {}
		tabObj.Page = page
		tabObj.Content = pageContent

		function tabObj:SetActive()
			activateTab(order)
		end

		function tabObj:AddSection(sectionTitle)
			local section = {}
			local sectionFrame = Instance.new("Frame")
			sectionFrame.Size = UDim2.new(1, 0, 0, 80)
			sectionFrame.BackgroundTransparency = 1
			sectionFrame.LayoutOrder = #pageContent:GetChildren() + 1
			sectionFrame.Parent = pageContent

			local titleLabel = Instance.new("TextLabel")
			titleLabel.Size = UDim2.new(1, 0, 0, 24)
			titleLabel.Position = UDim2.fromOffset(0, 0)
			titleLabel.BackgroundTransparency = 1
			titleLabel.Text = tostring(sectionTitle or "SECTION")
			titleLabel.Font = Enum.Font.GothamBold
			titleLabel.TextSize = 18
			titleLabel.TextColor3 = Color3.fromRGB(0, 160, 255)
			titleLabel.TextXAlignment = Enum.TextXAlignment.Left
			titleLabel.Parent = sectionFrame

			local itemsFrame = Instance.new("Frame")
			itemsFrame.Size = UDim2.new(1, 0, 0, 48)
			itemsFrame.Position = UDim2.new(0, 0, 0, 28)
			itemsFrame.BackgroundTransparency = 1
			itemsFrame.Parent = sectionFrame

			local itemsLayout = Instance.new("UIListLayout")
			itemsLayout.Parent = itemsFrame
			itemsLayout.SortOrder = Enum.SortOrder.LayoutOrder
			itemsLayout.Padding = UDim.new(0, 8)

			-- ONLY Section:AddLabel is exposed
			function section:AddLabel(text)
				local lblHolder = Instance.new("Frame")
				lblHolder.Size = UDim2.new(1, 0, 0, 40)
				lblHolder.BackgroundTransparency = 1
				lblHolder.LayoutOrder = #itemsFrame:GetChildren() + 1
				lblHolder.Parent = itemsFrame

				local lblBg = Instance.new("Frame")
				lblBg.Size = UDim2.new(1, -8, 1, 0)
				lblBg.Position = UDim2.new(0, 4, 0, 0)
				lblBg.BackgroundColor3 = Color3.fromRGB(30, 30, 33)
				lblBg.BorderSizePixel = 0
				lblBg.ZIndex = 7
				lblBg.Parent = lblHolder
				Instance.new("UICorner", lblBg).CornerRadius = UDim.new(0, 8)

				local lblText = Instance.new("TextLabel")
				lblText.Size = UDim2.new(1, -16, 1, 0)
				lblText.Position = UDim2.new(0, 8, 0, 0)
				lblText.BackgroundTransparency = 1
				lblText.Text = tostring(text or "")
				lblText.Font = Enum.Font.Gotham
				lblText.TextSize = 16
				lblText.TextColor3 = Color3.fromRGB(235, 235, 235)
				lblText.TextXAlignment = Enum.TextXAlignment.Left
				lblText.Parent = lblBg
				lblText.ZIndex = 8

				local labelObj = {}
				labelObj.Frame = lblHolder
				labelObj.Background = lblBg
				labelObj.Label = lblText
				function labelObj:SetText(newText)
					lblText.Text = tostring(newText or "")
				end
				return labelObj
			end

			section.Frame = sectionFrame
			section.Title = titleLabel
			section.Items = itemsFrame

			-- store on pagesSections for Main:AddButton lookups
			table.insert(pagesSections[order], section)

			setmetatable(section, { __index = section })
			return section
		end

		return tabObj
	end

	-- AddButton: convenience API to create a Button element and place it into a section.
	-- It requires an element module at src/elements/Button.lua (adjust require path as needed).
	function api:AddButton(config)
		config = config or {}
		-- determine parent itemsFrame: priority: config.Parent, config.Section, current active page's first section
		local targetParent = config.Parent
		if not targetParent and config.Section then
			-- if a section object was passed directly
			if type(config.Section) == "table" and config.Section.Items then
				targetParent = config.Section.Items
			end
		end
		if not targetParent and activeIndex then
			local secs = pagesSections[activeIndex]
			if secs and #secs > 0 then
				targetParent = secs[#secs].Items -- add to last section by default
			end
		end
		if not targetParent then
			-- fallback: create a default section on current page or first page
			local pageIndex = activeIndex or 1
			if not pages[pageIndex] then
				-- create a first tab if none exist
				local t = api:AddTab("Default")
				pageIndex = 1
			end
			local tab = { Page = pages[pageIndex], Content = pages[pageIndex]:FindFirstChild("Content") }
			-- create a new section
			local section = nil
			-- find the tabObj by index to call AddSection properly
			-- quick recreate a tabObj like above
			local tabObj = {}
			tabObj.Page = pages[pageIndex]
			tabObj.Content = pages[pageIndex]:FindFirstChild("Content")
			function tabObj:AddSection(sTitle)
				local section = {}
				local pageContent = tabObj.Content
				local sectionFrame = Instance.new("Frame")
				sectionFrame.Size = UDim2.new(1, 0, 0, 80)
				sectionFrame.BackgroundTransparency = 1
				sectionFrame.LayoutOrder = #pageContent:GetChildren() + 1
				sectionFrame.Parent = pageContent

				local titleLabel = Instance.new("TextLabel")
				titleLabel.Size = UDim2.new(1, 0, 0, 24)
				titleLabel.Position = UDim2.fromOffset(0, 0)
				titleLabel.BackgroundTransparency = 1
				titleLabel.Text = tostring(sTitle or "SECTION")
				titleLabel.Font = Enum.Font.GothamBold
				titleLabel.TextSize = 18
				titleLabel.TextColor3 = Color3.fromRGB(0, 160, 255)
				titleLabel.TextXAlignment = Enum.TextXAlignment.Left
				titleLabel.Parent = sectionFrame

				local itemsFrame = Instance.new("Frame")
				itemsFrame.Size = UDim2.new(1, 0, 0, 48)
				itemsFrame.Position = UDim2.new(0, 0, 0, 28)
				itemsFrame.BackgroundTransparency = 1
				itemsFrame.Parent = sectionFrame

				local itemsLayout = Instance.new("UIListLayout")
				itemsLayout.Parent = itemsFrame
				itemsLayout.SortOrder = Enum.SortOrder.LayoutOrder
				itemsLayout.Padding = UDim.new(0, 8)

				section.Frame = sectionFrame
				section.Title = titleLabel
				section.Items = itemsFrame
				return section
			end
			section = tabObj:AddSection("Default")
			targetParent = section.Items
		end

		-- ensure targetParent is a frame (items container)
		if not targetParent or not targetParent:IsA("Instance") then
			error("Main:AddButton: invalid target parent for button")
		end

		-- require button element (adjust path as necessary)
		local ok, ElementModule = pcall(function()
			-- try relative path; in your project you may require differently
			return require(script.Parent:WaitForChild("elements"):WaitForChild("Button"))
		end)
		if not ok or not ElementModule then
			-- try other fallback require path
			local ok2, mod = pcall(function() return require(script:FindFirstChild("elements") and script.elements.Button or nil) end)
			if not ok2 then error("AddButton: could not require elements.Button module; adjust path") end
			ElementModule = mod
		end

		-- attach parent into config so component will parent itself properly
		config.Parent = targetParent

		local _, Button = ElementModule:New(config)
		-- return the Button object (user expectation)
		return Button
	end

	function api:Show() Window.Visible = true end
	function api:Hide() Window.Visible = false end
	function api:Destroy() ScreenGui:Destroy() end

	return api
end

return KazeUI
